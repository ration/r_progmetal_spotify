# Implementation Plan: Multi-Tab Google Sheets Parsing

**Branch**: `005-multi-tab-parsing` | **Date**: 2025-01-05 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/005-multi-tab-parsing/spec.md`

## Summary

Enhance the Google Sheets synchronization system to parse and import albums from all available tabs (year-based progressive metal tabs from 2017-2025) instead of a single tab specified by `gid` parameter. The system will filter tabs by name pattern (only "Prog-metal" tabs), process them chronologically from oldest to newest, track per-tab progress, handle tab-specific errors gracefully, and skip cross-tab duplicates based on `spotify_album_id`.

## Technical Context

**Language/Version**: Python 3.13+
**Primary Dependencies**: Django 5.2.6, openpyxl 3.1+, requests 2.31+, spotipy 2.24+
**Storage**: PostgreSQL (production), SQLite (development) via Django ORM
**Testing**: pytest with Django test framework (tests explicitly required in spec for multi-tab scenarios)
**Target Platform**: Linux server (Docker), macOS/Linux local development
**Project Type**: Web application (Django backend with HTMX frontend)
**Performance Goals**: Import 250+ albums from 11 tabs in under 5 minutes
**Constraints**: Real-time progress updates every 2 seconds, sequential tab processing, Spotify API rate limits
**Scale/Scope**: 11 progressive metal tabs spanning 2017-2025, ~250 albums total

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with `.specify/memory/constitution.md` principles:

- [X] **Specification-Driven**: Feature spec completed and validated (spec.md with all clarifications resolved)
- [X] **Type Safety & Code Quality**: Implementation will include type annotations (pyright), linting (ruff), and docstrings
- [X] **User-Centric Design**: Implementation organized by prioritized user stories (P1: Multi-tab import, P2: Multi-year statistics, P3: Error handling)
- [X] **Test Independence**: Test requirements explicitly defined in spec (contract tests for tab enumeration, integration tests for multi-tab sync, TDD approach)
- [X] **Incremental Delivery**: Tasks structured to deliver P1 (core multi-tab parsing) independently, P2 builds on P1, P3 enhances resilience

**Violations**: None

## Project Structure

### Documentation (this feature)

```text
specs/005-multi-tab-parsing/
├── spec.md              # Feature specification (completed)
├── plan.md              # This file (implementation plan)
├── research.md          # Phase 0: openpyxl multi-tab API, tab filtering patterns
├── data-model.md        # Phase 1: TabMetadata entity, SyncOperation enhancements
├── quickstart.md        # Phase 1: Setup multi-tab URL, verify tab detection
├── contracts/           # Phase 1: GoogleSheetsService API contracts
│   └── google-sheets-api.md
├── checklists/
│   └── requirements.md  # Specification quality checklist (completed)
└── tasks.md             # Phase 2: Generated by /speckit.tasks command

```

### Source Code (repository root)

```text
catalog/
├── services/
│   ├── google_sheets.py        # MODIFY: Add multi-tab enumeration/filtering
│   ├── sync_manager.py          # MODIFY: Add per-tab progress tracking
│   └── album_importer.py        # NO CHANGE: Existing logic handles per-album
├── models.py                    # MODIFY: SyncOperation.current_tab field
├── views.py                     # MODIFY: Sync status shows tab breakdown
└── migrations/
    └── 0005_add_current_tab.py  # NEW: Add current_tab to SyncOperation

tests/
├── services/
│   └── test_google_sheets_multi_tab.py  # NEW: Tab enumeration tests (TDD)
├── integration/
│   └── test_multi_tab_sync.py           # NEW: End-to-end multi-tab sync (TDD)
└── fixtures/
    └── multi_tab_sheet.xlsx             # NEW: Test fixture with multiple tabs

.env
└── GOOGLE_SHEETS_XLSX_URL               # MODIFY: Remove gid parameter
```

**Structure Decision**: This is a web application (Django backend with HTMX frontend). We're enhancing the existing `catalog/services/google_sheets.py` module to support multi-tab parsing. No new modules needed - the enhancement is localized to the Google Sheets service layer with minimal changes to models and views for progress tracking.

## Complexity Tracking

> **No violations - table not needed**

---

## Phase 0: Research & Unknowns

### Research Tasks

1. **openpyxl Multi-Tab API** (NEEDS CLARIFICATION)
   - How to enumerate all sheets in a workbook without loading data?
   - API for sheet metadata (name, visibility, order)?
   - Performance implications of loading entire workbook vs individual sheets?

2. **Tab Filtering Patterns** (NEEDS CLARIFICATION)
   - Best practices for name pattern matching (regex vs string methods)?
   - How to handle edge cases (whitespace, case sensitivity)?
   - Should we use a whitelist or blacklist approach?

3. **Chronological Sorting** (NEEDS CLARIFICATION)
   - Algorithm for extracting year from tab names like "2025 Prog-metal"?
   - Handling non-year tabs (e.g., "2017", "2018" without suffix)?
   - Fallback behavior if year extraction fails?

4. **Progress Tracking Strategy** (NEEDS CLARIFICATION)
   - Should SyncOperation model store current tab name as string field?
   - How to represent multi-tab progress: "Tab 3/11 (2023 Prog-metal): 45/50 albums"?
   - Update frequency for tab transitions vs within-tab progress?

5. **Error Isolation** (NEEDS CLARIFICATION)
   - How to continue processing remaining tabs if one fails?
   - Should we collect all tab errors and report at end, or stop on first critical error?
   - What constitutes a "critical" vs "recoverable" tab error?

### Output

Research findings will be documented in `research.md` with:
- **Decision**: Selected approach for each unknown
- **Rationale**: Why chosen over alternatives
- **Alternatives considered**: What was evaluated but rejected

---

## Phase 1: Design & Contracts

**Prerequisites**: `research.md` complete with all NEEDS CLARIFICATION resolved

### Deliverables

1. **data-model.md**: Document enhancements to existing entities
   - **SyncOperation**: Add `current_tab: str` field to track active tab name
   - **TabMetadata** (ephemeral, not persisted): Name, year, order, row_count

2. **contracts/google-sheets-api.md**: Define GoogleSheetsService API changes
   - `enumerate_tabs() -> List[TabMetadata]`: List all tabs with metadata
   - `filter_tabs(List[TabMetadata]) -> List[TabMetadata]`: Apply prog-metal filter
   - `sort_tabs_chronologically(List[TabMetadata]) -> List[TabMetadata]`: Sort by year
   - `fetch_albums_from_tab(tab_name: str) -> List[Dict]`: Fetch from specific tab

3. **quickstart.md**: Setup instructions for multi-tab mode
   - Update `.env` to remove `gid` parameter from GOOGLE_SHEETS_XLSX_URL
   - Verify tab detection with management command: `python manage.py list_sheet_tabs`
   - Test multi-tab sync with: `python manage.py import_albums --multi-tab`

4. **Update agent context**:
   - Run `.specify/scripts/bash/update-agent-context.sh claude`
   - Add openpyxl multi-tab patterns to `CLAUDE.md` active technologies

### Design Decisions

- **Tab filtering**: Use string.endswith("Prog-metal") OR tab name matches regex `^\d{4}$`
- **Chronological sorting**: Extract year from tab name, sort numerically ascending
- **Progress tracking**: Update SyncOperation.current_tab on each tab transition
- **Error handling**: Catch per-tab exceptions, log, continue with remaining tabs

---

## Phase 2: Task Generation

**Command**: `/speckit.tasks`
**Prerequisites**: Phase 0-1 complete, all design artifacts validated

This phase is NOT executed by `/speckit.plan` - it's a separate command that generates the task breakdown in `tasks.md`.

---

## Success Criteria Mapping

| Success Criterion | Implementation Approach |
|-------------------|-------------------------|
| SC-001: Import all tabs in <5min | Sequential processing with Spotify rate limit handling |
| SC-002: 0% duplicate imports | Existing spotify_album_id check in sync_manager.py (already skip-based) |
| SC-003: Progress updates every 2s | Existing HTMX polling, enhance status message to show "Tab X/Y: [name]" |
| SC-004: 1/5 tab failure doesn't abort | Wrap per-tab processing in try/except, aggregate errors in SyncOperation |
| SC-005: View complete multi-year catalog | No changes needed - existing album_list view shows all imported albums |
| SC-006: Tab-level breakdown in status | Enhance sync_status view template to render per-tab results |

---

## Migration Strategy

1. **Phase 0**: Research and validate openpyxl multi-tab APIs
2. **Phase 1**: Design TabMetadata, GoogleSheetsService enhancements, contracts
3. **Phase 2**: Generate tasks in priority order (P1 first)
4. **Implementation**: Execute tasks via `/speckit.implement` command
5. **Testing**: TDD approach - write tests before implementation for multi-tab logic
6. **Validation**: Verify all 3 user stories independently testable

---

## Risks & Mitigation

| Risk | Probability | Impact | Mitigation |
|------|-------------|--------|------------|
| Tab names change format | Low | High | Store flexible regex patterns, log unmatched tabs |
| Spotify rate limits | Medium | Medium | Existing backoff logic, sequential processing |
| openpyxl performance with 11 tabs | Low | Medium | Use read_only=True mode, lazy sheet loading |
| Duplicate albums across tabs | High | Low | Already mitigated by existing spotify_album_id check |

---

**Plan Status**: Phase 0 research pending
**Next Steps**: Resolve NEEDS CLARIFICATION items in research.md, then proceed to Phase 1 design
